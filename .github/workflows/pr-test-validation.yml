name: Validate PR Test Coverage

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]
    branches:
      - "feature/**"
      - "Feature/**"
      - "FEATURE/**"
      - "staging"
      - "main"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-tests:
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine repository type and bypass
        id: repo_check
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          echo "Repository: $REPO"

          BYPASS_LIST=(
            "Eshopbox-Enginnering/poe-frontend"
            "Eshopbox-Enginnering/amzWholesale-Warehouse-Portal-Frontend"
            "Eshopbox-Enginnering/eshopbox-wms-api"
            "Eshopbox-Enginnering/clickpost-microservice"
            "Eshopbox-Enginnering/eshopbox-wms-middleware"
            "Eshopbox-Enginnering/unicommerce-microservice"
            "Eshopbox-Enginnering/unicommerce-inventory-microservice"
            "Eshopbox-Enginnering/eshopbox-wms-backend"
            "Eshopbox-Enginnering/myntra-microservices"
            "Eshopbox-Enginnering/scan-label"
            "Eshopbox-Enginnering/eshopbox-client-services"
            "Eshopbox-Enginnering/org-actions"
          )

          if printf '%s\n' "${BYPASS_LIST[@]}" | grep -q "^$REPO$"; then
            echo "bypass=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Repo is bypassed."
          elif [ "$REPO" = "Eshopbox-Enginnering/eshopbox-client-portal-frontend" ]; then
            echo "type=angular" >> "$GITHUB_OUTPUT"
            echo "bypass=false" >> "$GITHUB_OUTPUT"
          else
            echo "type=java" >> "$GITHUB_OUTPUT"
            echo "bypass=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect revert PR/commit
        id: revert_check
        shell: bash
        run: |
          set -euo pipefail
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          echo "PR title: $TITLE"

          is_revert="false"

          if echo "$TITLE" | grep -Eiq '^\s*revert\b'; then
            is_revert="true"
          elif echo "${BODY:-}" | grep -Eiq 'this reverts commit'; then
            is_revert="true"
          else
            git fetch origin "${{ github.base_ref }}" --quiet || true
            if git log --format=%s "origin/${{ github.base_ref }}...HEAD" 2>/dev/null | grep -Eiq '\b(revert|reverted|reverting)\b'; then
              is_revert="true"
            fi
          fi

          echo "is_revert=$is_revert" >> "$GITHUB_OUTPUT"

          if [ "$is_revert" = "true" ]; then
            echo "‚úÖ Revert detected. Skipping test coverage validation."
          else
            echo "‚úÖ Not a revert."
          fi

      - name: Revert PR ‚Äî skip validation
        if: steps.revert_check.outputs.is_revert == 'true'
        shell: bash
        run: |
          echo "‚úÖ Revert PR/commit detected. Validation skipped."

      - name: Skip validation for bypassed repos
        if: steps.repo_check.outputs.bypass == 'true'
        shell: bash
        run: |
          echo "‚úÖ Skipping validation for bypassed repo."

      - name: Detect code changes in PR
        id: changes
        if: steps.repo_check.outputs.bypass != 'true' && steps.revert_check.outputs.is_revert != 'true'
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --quiet || true

          # Union of paths you care about across Angular + Java
          git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- \
            src/ libs/ apps/ src/main/java/ src/test/java/ > changed_files.txt || true

          echo "üîç Changed files:"
          cat changed_files.txt || true

          if [ ! -s changed_files.txt ]; then
            echo "‚úÖ No changes found in monitored paths."
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: No changes ‚Äî skip validation
        if: steps.revert_check.outputs.is_revert != 'true' && steps.changes.outputs.no_changes == 'true'
        shell: bash
        run: |
          echo "‚úÖ No relevant changes. Skipping validation."
          exit 0

      ####################################
      # Angular validation
      ####################################
      - name: Validate Angular test changes
        id: angular_check
        if: steps.repo_check.outputs.type == 'angular' && steps.repo_check.outputs.bypass != 'true' && steps.revert_check.outputs.is_revert != 'true' && steps.changes.outputs.no_changes != 'true'
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --quiet || true

          # Include html/scss so they are detected, but tests are only enforced for logic TS files
          git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- src/ libs/ apps/ > changed_files.txt || true

          echo "üîç Changed files:"
          cat changed_files.txt || true

          # Require tests only when Angular logic TS files change (ignore html/scss-only changes)
          FILES=$(grep -E '\.(component|service|pipe|directive)\.ts$' changed_files.txt | grep -v '\.spec\.ts$' || true)

          if [ -z "${FILES:-}" ]; then
            echo "‚úÖ No Angular logic .ts files changed (or only html/scss changed)."
            exit 0
          fi

          echo "üß© Files requiring .spec.ts:"
          echo "$FILES"

          MISSING=0
          for f in $FILES; do
            dir="$(dirname "$f")"
            base="$(basename "$f" .ts)"
            test_file="$dir/${base}.spec.ts"
            if ! grep -qF "$test_file" changed_files.txt; then
              echo "‚ùå Missing test for $f (expected $test_file in PR)"
              MISSING=$((MISSING+1))
            fi
          done

          if [ "$MISSING" -gt 0 ]; then
            echo "Angular test validation failed: $MISSING missing"
            exit 1
          else
            echo "‚úÖ All modified Angular logic files have tests."
          fi

      - name: Comment on PR ‚Äî Angular missing tests
        if: always() && steps.revert_check.outputs.is_revert != 'true' && steps.changes.outputs.no_changes != 'true' && steps.angular_check.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ‚ö†Ô∏è **Test file missing in PR**
            Some Angular logic files (`.component.ts`, `.service.ts`, `.pipe.ts`, `.directive.ts`) were changed without corresponding `.spec.ts` test updates.
            Changes only in `.html` / `.scss` do not require unit test updates, but logic `.ts` changes do.

      - name: Fail workflow if Angular validation failed
        if: steps.revert_check.outputs.is_revert != 'true' && steps.changes.outputs.no_changes != 'true' && steps.angular_check.outcome == 'failure'
        shell: bash
        run: |
          echo "‚ùå Failing because Angular test validation failed."
          exit 1

      ####################################
      # Java validation (focused on DAO, Service, Endpoint, Controller)
      ####################################
      - name: Validate Java test changes
        id: java_check
        if: steps.repo_check.outputs.type == 'java' && steps.repo_check.outputs.bypass != 'true' && steps.revert_check.outputs.is_revert != 'true' && steps.changes.outputs.no_changes != 'true'
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --quiet || true
          git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- src/main/java/ src/test/java/ > changed_files.txt || true

          echo "üîç Changed files:"
          cat changed_files.txt || true

          # Only consider key logic layers for validation
          FILES=$(grep -E '^src/main/java/.*/(dao|service|endpoint|controller)/.*\.java$' changed_files.txt | grep -v -E '(Test|Tests|IT)\.java$' || true)

          if [ -z "${FILES:-}" ]; then
            echo "‚úÖ No relevant Java (DAO/Service/Endpoint/Controller) files changed."
            exit 0
          fi

          echo "üß© Files requiring test validation:"
          echo "$FILES"

          MISSING=0
          for f in $FILES; do
            rel_path="$(echo "$f" | sed 's|^src/main/java/||')"
            t1="src/test/java/${rel_path%.java}Test.java"
            t2="src/test/java/${rel_path%.java}Tests.java"
            t3="src/test/java/${rel_path%.java}IT.java"

            if grep -qF "$t1" changed_files.txt || grep -qF "$t2" changed_files.txt || grep -qF "$t3" changed_files.txt; then
              echo "‚úÖ Found test for $f"
            else
              echo "‚ùå Missing test for $f (expected one of: $t1 / $t2 / $t3 in PR)"
              MISSING=$((MISSING+1))
            fi
          done

          if [ "$MISSING" -gt 0 ]; then
            echo "Java test validation failed: $MISSING missing"
            exit 1
          else
            echo "‚úÖ All modified Java (DAO/Service/Endpoint/Controller) files have tests."
          fi

      - name: Comment on PR ‚Äî Java missing tests
        if: always() && steps.revert_check.outputs.is_revert != 'true' && steps.changes.outputs.no_changes != 'true' && steps.java_check.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ‚ö†Ô∏è **Test file missing in PR**
            Some Java files were changed without corresponding test updates under `src/test/java`.
            Please add or update the required test files before merging.

      - name: Fail workflow if Java validation failed
        if: steps.revert_check.outputs.is_revert != 'true' && steps.changes.outputs.no_changes != 'true' && steps.java_check.outcome == 'failure'
        shell: bash
        run: |
          echo "‚ùå Failing because Java test validation failed."
          exit 1
