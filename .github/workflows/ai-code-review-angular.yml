# Reusable workflow (single source of truth). No inputs; all config centralized here.
name: Codex AI Code Review (Angular)

on:
  workflow_call: {}
  workflow_dispatch:  # Allow manual run

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-review-angular-${{ github.repository }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  ai_review:
    name: AI Code Review
    if: ${{ github.event_name != 'pull_request' || !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      AI_PROVIDER: openai
      AI_TEMPERATURE: "0.3"
      MAX_COMMENTS: "12"
      APPROVE_REVIEWS: "false"

      EXCLUDE_PATTERNS: >-
        **/*.lock,**/*.json,**/*.md,**/*.yml,**/*.yaml,
        **/dist/**,**/storybook-static/**,**/coverage/**,
        **/*.spec.ts,**/*.stories.ts,**/__snapshots__/**,
        **/*.svg,**/*.png,**/*.jpg,**/*.jpeg,**/*.gif,**/*.mp4,
        **/e2e/**

      PROJECT_CONTEXT: |
        This is an Angular (TypeScript) monorepo.
        - Angular 9.1 with SCSS
        - Uses NGRX, Angular Material
        - Avoid inline styles
        - Ensure a11y compliance and performance best practices

      MAX_FILE_BYTES: "30000"   # tighter 30 KB cutoff

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Detect relevant changes
        id: changes
        run: |
          git fetch origin ${{ github.base_ref }} --quiet || true
          if git diff --quiet origin/${{ github.base_ref }}...HEAD -- src/ libs/ apps/; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Build payload and split into chunks
        if: steps.changes.outputs.no_changes == 'false'
        id: payload
        run: |
          set -euo pipefail
          git fetch origin ${{ github.base_ref }} --depth=1 --quiet

          : > payload.txt
          counted=0
          total_bytes=0
          large=false

          for f in $(git diff --name-only origin/${{ github.base_ref }}...HEAD -- src/ libs/ apps/); do
            [ -f "$f" ] || continue
            sz=$(wc -c <"$f" | tr -d ' ')
            total_bytes=$((total_bytes + sz))
            if [ "$sz" -gt "${{ env.MAX_FILE_BYTES }}" ]; then
              echo "### Diff for $f" >> payload.txt
              git diff -U3 origin/${{ github.base_ref }}...HEAD -- "$f" >> payload.txt
              large=true
            else
              echo "### Full content of $f" >> payload.txt
              cat "$f" >> payload.txt
            fi
            counted=$((counted + 1))
          done

          # Split payload into ~8k-line chunks (~80-100k tokens each max)
          mkdir chunks
          split -l 8000 payload.txt chunks/chunk_

          echo "files_count=$counted"  >> $GITHUB_OUTPUT
          echo "chunk_count=$(ls chunks | wc -l)" >> $GITHUB_OUTPUT

          {
            echo "### AI Review Preflight (Angular)"
            echo "- Files counted: **$counted**"
            echo "- Chunks created: **$(ls chunks | wc -l)**"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Jitter to reduce org-wide bursts (5â€“25s)
        if: steps.payload.outputs.files_count != '0'
        run: sleep $(( (RANDOM % 21) + 5 ))

      - name: Run AI Code Review per chunk
        if: steps.payload.outputs.files_count != '0'
        run: |
          for f in chunks/*; do
            echo "ðŸ”Ž Reviewing $f ..."
            gh api \
              repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              -f event=COMMENT \
              -f body="$(cat "$f" | npx eshopbox-ai-codereviewer \
                --provider $AI_PROVIDER \
                --apikey ${{ secrets.AI_REVIEW_CODEX }} \
                --model gpt-4.1-mini-long-context \
                --temperature $AI_TEMPERATURE \
                --max-comments $MAX_COMMENTS \
                --project-context \"$PROJECT_CONTEXT\" \
                --exclude \"$EXCLUDE_PATTERNS\")"
          done

      - name: Skip log message
        if: steps.changes.outputs.no_changes == 'true'
        run: echo "âœ… No relevant Angular code changes â€” skipping AI review."
