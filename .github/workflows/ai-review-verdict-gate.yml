name: AI Review Verdict Gate

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  gate:
    name: Block merge if AI verdict is Request Changes
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Evaluate AI verdict and comment result
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request context found.");
              return;
            }

            const { owner, repo } = context.repo;

            // Fetch PR comments (AI review is posted as an issue comment)
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pr.number,
              per_page: 100
            });

            // Latest comment containing Verdict:
            const ai = comments
              .filter(c => (c.body || "").includes("Verdict:"))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

            let verdict = "UNKNOWN";
            let confidence = "N/A";

            if (ai) {
              const verdictMatch = ai.body.match(/Verdict:\s*(.+)/i);
              verdict = verdictMatch ? verdictMatch[1].trim() : "UNKNOWN";

              const confMatch = ai.body.match(/Confidence:\s*(.+)/i);
              confidence = confMatch ? confMatch[1].trim() : "N/A";
            }

            const isBlock = /(request|require|requires)\s+changes/i.test(verdict);

            const gateBody =
              `### ✅ AI Review Gate Result\n` +
              `- **Detected AI Verdict:** ${verdict}\n` +
              `- **Detected Confidence:** ${confidence}\n` +
              `- **Gate Decision:** ${isBlock ? "❌ Block merge (changes required)" : "✅ Pass"}\n\n` +
              `> This comment is posted by the AI gate workflow.`;

            // Post the final result as a PR comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body: gateBody
            });

            // Fail the check to block merge (once this check is marked required in rulesets)
            if (!ai) {
              core.setFailed("AI review verdict not found (no comment with 'Verdict:').");
              return;
            }

            if (isBlock) {
              core.setFailed(`Blocking merge: AI verdict is '${verdict}'.`);
            }
